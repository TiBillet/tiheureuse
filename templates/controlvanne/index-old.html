<!doctype html><html lang="fr"><head>
<meta charset="utf-8"><title>Panneau vanne — WebSocket</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:20px;max-width:720px}
.card{border:1px solid #ddd;border-radius:12px;padding:16px;margin-bottom:16px}
.badge{display:inline-block;padding:6px 10px;border-radius:999px;background:#eee}
.badge.on{background:#d1f7c4}.badge.off{background:#ffd1d1}
.stat{font-size:18px;margin:6px 0}.mono{font-family:ui-monospace,Consolas,monospace}#status{color:#666}
</style></head><body>
<h1>Panneau vanne — WebSocket</h1><p><a href="/admin/">Admin</a></p>
<div class="card">
  <div class="stat">Vanne: <span id="etat" class="badge off">Fermée</span></div>
  <div>Carte présente: <b id="present">non</b></div>
  <div>UID: <span id="uid" class="mono">—</span></div>
  <div>Autorisation: <b id="auth">—</b></div>
  <div>Débit: <b id="debit">0.00</b> L/min &nbsp; Volume: <b id="volume">0</b> mL</div>
  <div id="msg" style="color:#555;margin-top:6px"></div>
  <div id="status"></div>
</div>
<script>
(function(){
  const etat=document.getElementById('etat'),present=document.getElementById('present'),uid=document.getElementById('uid'),
        auth=document.getElementById('auth'),debit=document.getElementById('debit'),volume=document.getElementById('volume'),
        msg=document.getElementById('msg'),statusEl=document.getElementById('status');
  const proto=(location.protocol==='https:')?'wss':'ws';
  const wsUrl=proto+'://'+location.host+'/ws/panel/'; let ws;
  function connect(){
    statusEl.textContent='Connexion…';
    ws=new WebSocket(wsUrl);
    ws.onopen=()=>{statusEl.textContent='Connecté ✓';};
    ws.onclose=()=>{statusEl.textContent='Déconnecté, reconnexion…'; setTimeout(connect,1000);};
    ws.onerror=()=>{statusEl.textContent='Erreur WebSocket';};
    ws.onmessage=(e)=>{try{
      const j=JSON.parse(e.data);
      etat.textContent=j.vanne_ouverte?'Ouverte':'Fermée';
      etat.className='badge '+(j.vanne_ouverte?'on':'off');
      present.textContent=j.present?'oui':'non';
      uid.textContent=j.uid||'—';
      auth.textContent=j.authorized?'autorisée':'refusée';
      debit.textContent=(j.debit_l_min||0).toFixed(2);
      volume.textContent=Math.round(j.volume_ml||0);
      msg.textContent=j.message||'';
    }catch(_){}};}
  connect();
})();
</script></body></html>
