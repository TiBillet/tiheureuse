{% extends "base.html" %}
{% block title %}Chez Mike's Bar{% endblock %}

{% block content %}
    <div class="alert alert-info">Vue ciblée : <strong>{{ becs }}</strong></div>

  <div class="row g-3" id="cards-grid">
    {% for b in becs %}
      <div class="col-12 col-md-6 col-lg-4" id="card-col-{{ b.slug }}">
        <div class="card h-100" data-slug="{{ b.slug }}">
          <div class="card-header d-flex justify-content-between align-items-center">
            <div>
              <span class="badge bg-secondary me-2">{{ b.slug }}</span>
              <strong class="text-info" id="liquid-{{ b.slug }}">{{ b.liquid_label|default:"Liquide" }}</strong>
            </div>
            <span class="badge bg-dark" id="agent-url-{{ b.slug }}">{{ b.agent_base_url|default:"Display" }}</span>
          </div>

          <div class="card-body">
            <div class="d-flex align-items-center mb-2">
              <span class="me-2">État vanne :</span>
              <span class="badge bg-danger" id="state-{{ b.slug }}">Fermée</span>
            </div>

            <div class="small text-muted">Tag carte NFC :</div>
            <div class="mb-2"><code id="uid-{{ b.slug }}">—</code></div>

            <div class="d-flex align-items-center mb-2">
              <span class="me-2">Autorisation :</span>
              <span class="badge bg-secondary" id="auth-{{ b.slug }}">—</span>
            </div>

            <div class="mb-2">
              <div class="d-flex justify-content-between">
                <span>Débit (L/min)</span>
                <span class="stat" id="flow-{{ b.slug }}">0.00</span>
              </div>
              <div class="progress" style="height:6px;">
                <div class="progress-bar" id="flowbar-{{ b.slug }}" role="progressbar" style="width:0%"></div>
              </div>
            </div>

            <div class="d-flex justify-content-between">
              <span>Volume (ml)</span>
              <span class="stat" id="vol-{{ b.slug }}">0</span>
            </div>
          </div>

          <div class="card-footer">
            <small id="msg-{{ b.slug }}" class="text-muted">En attente…</small>
          </div>
        </div>
      </div>
    {% empty %}
      <div class="col-12">
        <div class="alert alert-warning">Aucune tireuse définie.</div>
      </div>
    {% endfor %}
  </div>
{% endblock %}

{% block scripts %}
<script>
(function(){
  const cards = {};

  // Initialisation : On récupère les éléments HTML
  document.querySelectorAll('.card[data-slug]').forEach(card => {
    const s = card.dataset.slug.toLowerCase(); // On force le minuscule
    cards[s] = {
      slug: s,
      uid: document.getElementById('uid-'+s),
      auth: document.getElementById('auth-'+s),
      state: document.getElementById('state-'+s),
      flow: document.getElementById('flow-'+s),
      flowbar: document.getElementById('flowbar-'+s),
      vol: document.getElementById('vol-'+s),
      msg: document.getElementById('msg-'+s),
      liquid: document.getElementById('liquid-'+s),
      container: card // Utile pour debugging visuel eventuel
    };
  });

  // Fonction de Remise à Zéro (Mode gris)
  function resetCardUI(c) {
    if(!c) return;
    c.uid.innerHTML = '&mdash;';

    // On force le badge en GRIS
    c.auth.className = 'badge bg-secondary';
    c.auth.textContent = 'En attente';

    // Reset Vanne et Volumes
    c.state.className = 'badge bg-danger';
    c.state.textContent = 'Fermée';
    c.flow.textContent = '0.00';
    c.flowbar.style.width = '0%';
    c.vol.textContent = '0';
    c.msg.textContent = 'Posez votre badge...';
  }

  // Helper Couleurs
  function setBadge(el, ok){
    el.className = 'badge ' + (ok ? 'bg-success' : 'bg-danger');
    el.textContent = ok ? 'Autorisé' : 'Refusé';
  }

  // --- WEBSOCKET ---
  const proto = location.protocol === 'https:' ? 'wss' : 'ws';

  // Connexion au canal demandé (ou "all" par défaut)
  const slugFocus = "{{ slug_focus }}";
  const wsPath = (!slugFocus || slugFocus === 'all') ? '/ws/rfid/all/' : `/ws/rfid/${slugFocus}/`;

  const ws = new WebSocket(`${proto}://${location.host}${wsPath}`);

  ws.onopen = () => console.log("WS Connecté sur", wsPath);

  ws.onmessage = ev => {
      try {
          const data = JSON.parse(ev.data);
          const payload = data.payload || data;

          // Identification de la cible
          // Le Pi envoie peut-être "tireuse1" ou "Tireuse1", on normalise en minuscule
          const targetSlug = (payload.tireuse_bec || '').toLowerCase();

          // On cherche quelles cartes mettre à jour sur l'écran
          let targets = [];
          if (targetSlug === 'all') {
             targets = Object.values(cards); // Tout le mur
          } else if (cards[targetSlug]) {
             targets = [cards[targetSlug]]; // Une seule carte
          } else if (slugFocus === 'all') {
             // Si on est sur le mur ALL mais qu'on ne trouve pas la carte, on ignore ou on log
             console.warn("Reçu event pour", targetSlug, "mais pas de carte HTML trouvée.");
             return;
          }

          targets.forEach(c => {

              // -------------------------------------------------
              // CAS 1 : Carte présente sur le lecteur
              // -------------------------------------------------
              if (payload.present) {
                  c.uid.textContent = payload.uid || 'Lu...';

                  // Autorisation (Vert ou Rouge)
                  if (typeof payload.authorized !== 'undefined') {
                      setBadge(c.auth, payload.authorized);
                  }

                  // Vanne et Débit
                  if (payload.vanne_ouverte) {
                      c.state.className = 'badge bg-success';
                      c.state.textContent = 'Ouverte';
                  } else {
                      c.state.className = 'badge bg-danger';
                      c.state.textContent = 'Fermée';
                  }

                  c.flow.textContent = (payload.debit_l_min || 0).toFixed(2);
                  const flowPct = Math.min((payload.debit_l_min || 0) * 10, 100);
                  c.flowbar.style.width = flowPct + '%';
                  c.vol.textContent = (payload.volume_ml || 0).toFixed(0);

                  if (payload.message) c.msg.textContent = payload.message;
                  return;
              }

              // -------------------------------------------------
              // CAS 2 : Fin de session (avec un rapport final)
              // -------------------------------------------------
              if (payload.session_done) {
                  // On fige l'affichage en Bleu pour dire "Fini"
                  c.auth.className = 'badge bg-info text-dark';
                  c.auth.textContent = 'Terminé';
                  c.state.className = 'badge bg-danger';
                  c.state.textContent = 'Fermée';

                  c.vol.textContent = (payload.session_volume_ml || 0).toFixed(0);
                  if (payload.message) c.msg.textContent = payload.message;

                  // On efface tout après 4 secondes
                  setTimeout(() => resetCardUI(c), 4000);
                  return;
              }

              // -------------------------------------------------
              // CAS 3 : RETRAIT DE CARTE / PAS DE SESSION
              // -------------------------------------------------
              // Si on arrive ici, c'est que present=false et session_done=false.
              // C'est le cas : "J'ai retiré la carte sans verser" OU "Carte inconnue retirée".
              // ACTION : On efface tout, tout de suite.

              resetCardUI(c);
              if (payload.message) c.msg.textContent = payload.message;
          });

      } catch(e) { console.error("Erreur WS JS:", e); }
  };
})();
</script>




{% endblock %}
