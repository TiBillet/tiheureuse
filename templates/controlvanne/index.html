<!doctype html>
<html lang="fr">
    <head>
        <meta charset="utf-8"><title>Le Bar de Mike</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
    <style>
        body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:20px;max-width:720px}
        .card{border:1px solid #ddd;border-radius:12px;padding:16px;margin-bottom:16px}
        .badge{display:inline-block;padding:6px 10px;border-radius:999px;background:#eee}
        .badge.on{background:#d1f7c4}.badge.off{background:#ffd1d1}
        .stat{font-size:18px;margin:6px 0}.mono{font-family:ui-monospace,Consolas,monospace}#status{color:#666}
    </style></head>
    <body>
        <h1>Le Bar de Mike</h1><p><a href="/admin/">Admin</a></p>
<script>
(function () {
  // slug cible (exigé pour un kiosque par bec)
  const params = new URLSearchParams(location.search);
  let onlySlug = (params.get('tireuse_bec') || '').trim().toLowerCase();

  // crée (une fois) l'unique carte
  function ensureSingleCard() {
    let el = document.querySelector('#single-card');
    if (!el) {
      el = document.createElement('div');
      el.id = 'single-card';
      el.className = 'card';
      el.innerHTML = `
        <h2 style="margin-top:0">
          <span data-role="title">Liquide</span>
          <small style="color:#777">(<span data-role="slug">—</span>)</small>
        </h2>
        <div class="stat">Vanne: <span class="badge off" data-role="etat">Fermée</span></div>
        <div>Carte présente: <b data-role="present">non</b></div>
        <div>UID: <span class="mono" data-role="uid">—</span></div>
        <div>Autorisation: <b data-role="auth">—</b></div>
        <div>Débit: <b data-role="debit">0.00</b> L/min &nbsp; Volume: <b data-role="volume">0</b> mL</div>
        <div data-role="msg" style="color:#555;margin-top:6px"></div>
      `;
      document.body.appendChild(el);
    }
    // renvoie les refs vers les champs
    return {
      root: el,
      titleEl: el.querySelector('[data-role="title"]'),
      slugEl: el.querySelector('[data-role="slug"]'),
      etat: el.querySelector('[data-role="etat"]'),
      present: el.querySelector('[data-role="present"]'),
      uid: el.querySelector('[data-role="uid"]'),
      auth: el.querySelector('[data-role="auth"]'),
      debit: el.querySelector('[data-role="debit"]'),
      volume: el.querySelector('[data-role="volume"]'),
      msg: el.querySelector('[data-role="msg"]'),
    };
  }

  const card = ensureSingleCard();

  // si on a un slug ciblé, afficher tout de suite l’entête
  if (onlySlug) {
    card.slugEl.textContent = onlySlug;
    card.titleEl.textContent = 'Chargement…';
  }

  // construit l'URL WS pour un slug donné
  function wsUrlFromSlug(slug){
    const proto = (location.protocol === 'https:') ? 'wss' : 'ws';
    const q = slug ? ('?tireuse_bec=' + encodeURIComponent(slug)) : '';
    return proto + '://' + location.host + '/ws/panel/' + q;
  }

  let ws = null;
  function connect(){
    const wsUrl = wsUrlFromSlug(onlySlug);
    ws = new WebSocket(wsUrl);

    ws.onmessage = (e) => {
      const j = JSON.parse(e.data);

      // redirection automatique après rename (message redirect_to)
      if (j.redirect_to) {
        const newSlug = String(j.redirect_to).trim().toLowerCase();
        if (newSlug && newSlug !== onlySlug) {
          onlySlug = newSlug;
          // update URL de la page sans recharger (utile au reboot)
          const newParams = new URLSearchParams(location.search);
          newParams.set('tireuse_bec', newSlug);
          history.replaceState(null, '', location.pathname + '?' + newParams.toString());
          try { ws.close(); } catch(e){}
          setTimeout(connect, 100);
          return;
        }
      }

      const slug = (j.tireuse_bec || onlySlug || 'default').toLowerCase();

      // si on a un slug ciblé, ignorer les autres
      if (onlySlug && slug !== onlySlug) return;

      // MAJ de l’unique carte
      card.slugEl.textContent = slug;
      card.titleEl.textContent = (j.liquid_label || 'Liquide');
      card.etat.textContent = j.vanne_ouverte ? 'Ouverte' : 'Fermée';
      card.etat.className = 'badge ' + (j.vanne_ouverte ? 'on' : 'off');
      card.present.textContent = j.present ? 'oui' : 'non';
      card.uid.textContent = j.uid || '—';
      card.auth.textContent = j.authorized ? 'autorisée' : 'refusée';
      card.debit.textContent = (j.debit_l_min || 0).toFixed(2);
      card.volume.textContent = Math.round(j.volume_ml || 0);
      card.msg.textContent = j.message || '';
    };

    ws.onclose = () => setTimeout(connect, 1000);
  }

  connect();
})();
</script>
</body></html>
